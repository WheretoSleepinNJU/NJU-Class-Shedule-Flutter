# iOS Widget & Live Activities 设计规范

## 目录

- [概述](#概述)
- [Widget 尺寸与内容](#widget-尺寸与内容)
- [Live Activities 设计](#live-activities-设计)
- [锁屏 Widget 设计](#锁屏-widget-设计)
- [数据逻辑与时间规则](#数据逻辑与时间规则)
- [信息优先级](#信息优先级)
- [实现清单](#实现清单)

---

## 概述

本文档定义了南哪课表（NJU Class Schedule）iOS Widget 和 Live Activities 的设计规范，包括各尺寸 Widget 的内容布局、信息优先级、时间逻辑等。

### 设计原则

1. **快速扫视（Glanceable）** - 用户能在1-2秒内获取关键信息
2. **信息优先级明确** - 教室、时间等行动信息绝对不能被截断
3. **动态智能** - 根据时间自动切换显示内容（当前课程/下一节课）
4. **一致性** - 所有尺寸的 Widget 保持视觉和信息层级的一致

---

## Widget 尺寸与内容

### 小组件（systemSmall）

**尺寸：** 约 155x155 pt

**显示内容：**
- 日期与周次信息
- 当前课程（详细）和下一节课（详细）
- 明天课程预告（简略）

**布局示例：**

``` 小尺寸 Widget - 当前课程 + 下一节课
┌─────────┐
│ 10.15 *周三*     │ *周三* 表示加粗、主题色
│> 生物信息学基础  │ 当前课程正常颜色字体，课程名加粗、开始时间加粗。这里左侧是一条贯穿整个当前课程的竖线，模仿日历的日程风格。竖线颜色使用课程主题色，右侧文字衬底使用课程主题色的淡色背景（圆角矩形）。
│| 教一-207 孙啸   │ 第二行淡色字体，教室加粗。
│| 09:50 - 12:15   │ 第三行淡色字体，结束时间加粗。
│> 数据结构        │ （下一门，中间留正常间距）课程名加粗、开始时间加粗。设计同上，但不展示第二行教室、教师、结束时间。
└─────────┘ 
```

**智能切换逻辑：**
1. 今日上课前和明天课程预告时，“当前课程”的位置显示“第一门”，“下一门”显示“第二门”（如果一共只有一门课，则“下一门”隐藏）。今日上课前，“今天还有 X 门课”显示“今天有 X 门课”（不显示“还”字）。明日课程预告时，显示“明天有 X 门课”，其他内容同前述。
2. “上课前”状态下（用户设置的提前时间内，如 15 分钟），显示“当前课程”为“下一门”。底部“下一门”区域变为“我已到达”按钮（与 Live Activity 联动）。另外，需要使用 RelavanceKit 的时间设置提高 Widget 在叠放中的优先级。
3. “我已到达”状态或课程开始后，“当前课程”显示正在上的课程，底部“下一门”显示“下一门”（如果有）。如果当前课程是最后一门课，则隐藏“下一门”区域。
4. 今日课程结束后，“当前课程”区域居中显示“今日课程已结束”。
5. 晚 21:00 之后（可设置），显示明日课程预告。内容见 1.。


**关键信息：**
1. 课程名称（超出则用...截断）
2. 教室（绝对不能截断）
3. 上课时间（绝对不能截断）
4. 授课教师（可以省略或截断）
5. 下课时间（可以省略或截断）

---

### 中组件（systemMedium）- 今日课程列表

**尺寸：** 约 329x155 pt

**显示内容：**
- 今日课程列表（3-4节课）
- 时间轴展示
- 当前正在上的课程高亮

**布局方案：时间轴 + 课程卡片列表**

```
┌──────────────────────────────────────┐
│ 📅 今日课程              共 4 节课    │
│ ────────────────────────────────────│
│ 08:00 │▌生物信息学基础               │
│ 09:50 │  教一-207 · 孙啸             │
│       │                              │
│ 10:10 │▌数据结构                     │
│ 12:00 │  仙II-220 · 张三             │
│       │                              │
│ 14:00 │▌计算机网络  ← 正在上课       │
│ 15:50 │  教二-105 · 李四             │
└──────────────────────────────────────┘
```

**特性：**
- 左侧时间轴（时间段）
- 课程色块指示器（使用课程颜色）
- 当前课程带绿色指示器/背景高亮
- 最多显示3-4节课，超出截断

**备选方案：左右分栏**
```
┌──────────────────────────────────────┐
│  当前课程        │     下一节课       │
│  ────────────   │   ──────────────  │
│  计算机网络      │   数据库原理       │
│  教二-105        │   仙II-301         │
│  李四            │   14:00 开始       │
│  还剩 25 分钟    │                    │
└──────────────────────────────────────┘
```
（优先实现时间轴方案，左右分栏作为备选）

---

### 大组件（systemLarge）- 全天课表

**尺寸：** 约 329x345 pt

**显示内容：**
- 今日完整课表（包括空闲时间段）
- 若今日课程结束，显示明日课程
- 时间轴可视化

**布局示例：**
```
┌──────────────────────────────────────┐
│ 📅 10月15日 周三          第 4 周     │
│                                      │
│ 08:00 ┌────────────────────────┐    │
│       │ 生物信息学基础          │    │
│       │ 教一-207 · 孙啸        │    │
│ 09:50 └────────────────────────┘    │
│                                      │
│ 10:10 ┌────────────────────────┐    │
│       │ 数据结构                │    │
│ 12:00 └────────────────────────┘    │
│                                      │
│ 14:00 ┌────────────────────────┐    │
│       │ 计算机网络 ← 正在上课   │    │
│ 15:50 └────────────────────────┘    │
│                                      │
│ 明天 2 节课 · 首节 09:50 开始        │
└──────────────────────────────────────┘
```

**特性：**
- 完整时间轴（显示空余时间）
- 课程卡片带颜色背景
- 当前课程高亮
- 底部显示明日预告
- 空闲时间段可视化（让用户知道休息时间）

**今日课程结束后：**
```
┌──────────────────────────────────────┐
│ ✨ 今日课程已结束                     │
│                                      │
│ 明日课程（10月16日 周四）             │
│                                      │
│ 08:00 ┌────────────────────────┐    │
│       │ 操作系统                │    │
│ 09:50 └────────────────────────┘    │
│                                      │
│ 14:00 ┌────────────────────────┐    │
│       │ 编译原理                │    │
│ 15:50 └────────────────────────┘    │
└──────────────────────────────────────┘
```

---

## Live Activities 设计

### 触发时机

**提前时间设置：**
- 默认：**15分钟**
- 可选：5分钟、10分钟、15分钟、20分钟、30分钟

**触发逻辑：**
1. 在下节课开始前 N 分钟（用户设置）自动创建 Live Activity
2. 课程开始后自动更新状态为"正在上课"
3. 课程结束后或用户点击"我已到达"后自动关闭

**设置位置：**
- 应用内：设置 → 通知与提醒 → 课前实时活动
- 开关：默认**开启**
- 提前时间：可调节

**可选增强设置：**
- ☐ 仅在校园内启用（基于位置）
- ☐ 周末是否启用
- ☐ 静默时段（如午休时间不启用）

---

### 灵动岛（Dynamic Island）设计

#### Minimal（最小态）

**显示内容：** 课程图标 + 课程颜色

```
[📚]  ← 使用课程主题色
```

---

#### Compact（紧凑态）

**布局：左侧课程名 + 右侧教室**

```
┌───────────────────────────┐
│ 生物信息学  │  教一-207   │
│    基础     │             │
└───────────────────────────┘
```

**设计要点：**
- **左侧（Leading）：** 课程名称
  - 允许2行换行
  - 超出2行显示 `...`
  - 字体：11pt, medium
  - 最大宽度：~80pt

- **右侧（Trailing）：** 教室名称
  - **绝对不能截断（...）**
  - 使用 `.fixedSize()` 强制完整显示
  - 可带图标：📍
  - 字体：12pt, semibold

**变体：带倒计时**
```
┌───────────────────────────┐
│ 计算机网络  │  仙II-220   │
│             │   15分      │
└───────────────────────────┘
```

---

#### Expanded（展开态）

**完整信息展示**

```
┌──────────────────────────────────┐
│ 📚 生物信息学基础          还有 15分钟│
│    教一-207 · 孙啸               │
│ ────────────────────────────── │
│ 09:50 - 12:15 (3节课)   [已到达] │
└──────────────────────────────────┘
```

**布局区域：**

**Leading（左上）：**
- 课程图标 + 课程名称（完整）
- 教室 + 教师

**Trailing（右上）：**
- 状态文本（即将开始/正在上课/即将结束）
- 剩余时间（倒计时）

**Bottom（底部）：**
- 上课时间段（09:50 - 12:15）
- 节次信息（第 1-3 节）
- 操作按钮："我已到达"

**状态与图标：**

| 状态           | 图标                | 颜色   | 文本       |
|---------------|---------------------|--------|-----------|
| upcoming      | clock               | 橙色   | 即将开始   |
| startingSoon  | bell.fill           | 红色   | 准备上课   |
| inProgress    | book.fill           | 绿色   | 正在上课   |
| ending        | checkmark.circle    | 蓝色   | 即将结束   |

---

### 锁屏/横幅视图（Lock Screen Banner）

**完整信息卡片**

```
┌──────────────────────────────────┐
│  10.15 周三              第 4 周  │
│                                   │
│  📚 生物信息学基础                │
│  📍 教一-207  👤 孙啸             │
│  🕐 09:50 - 12:15 (第 1-3 节)    │
│                                   │
│  ⏱️ 还有 15 分钟                  │
│                                   │
│  [我已到达]        [查看课表 →]   │
└──────────────────────────────────┘
```

**布局层次：**
1. **顶部栏：** 日期、星期、周次
2. **主体信息：**
   - 课程名称（允许2行换行）
   - 教室（完整）+ 教师（可截断）
   - 时间段 + 节次
3. **状态栏：** 倒计时/进度
4. **操作按钮：**
   - 主按钮："我已到达"（关闭 Live Activity）
   - 次按钮："查看课表"（打开 App）

**交互：**
- 点击主体 → 打开 App 并跳转到该课程详情
- 点击"我已到达" → 关闭 Live Activity
- 点击"查看课表" → 打开 App 课程表页面

---

### 自动关闭逻辑

**Live Activity 关闭条件：**
1. 课程开始后自动切换为"正在上课"状态，上课结束后自动关闭
2. 用户点击"我已到达"手动关闭
3. 用户到达教室附近（可选，基于定位）
4. 用户取消课程或课程被删除

**状态转换流程：**
```
创建 → upcoming（即将开始）
    ↓ 5分钟内
    → startingSoon（准备上课）
    ↓ 上课时间到
    → inProgress（正在上课）
    ↓ 快结束
    → ending（即将结束）
    ↓ 结束
    → 自动关闭
```

---

## 锁屏 Widget 设计

### 矩形锁屏 Widget（accessoryRectangular）

**尺寸：** 约 160x72 pt（较小的矩形区域）

**显示内容：**
- 当前课程或下一节课（动态切换）
- 核心信息：课程名、教室、教师、时间

**布局设计：**

```
┌────────────────────────────┐
│ 📚 生物信息学基础           │  ← 第1行：图标+课程名（允许2行换行）
│    概论与实践               │  ← 第2行：课程名续行（如有）
│ 📍教一-207·👤孙啸·09:50    │  ← 第3行：教室+教师+时间（紧凑）
└────────────────────────────┘
```

**超长课程名处理：**
```
┌────────────────────────────┐
│ 📚 马克思主义基本原理概论   │  ← 第1行
│    与中国特色社会主义...    │  ← 第2行，超出显示...
│ 📍仙II-301·李明·14:00      │  ← 第3行
└────────────────────────────┘
```

**显示逻辑：**

| 时间条件             | 显示内容       | 图标        |
|---------------------|---------------|------------|
| 正在上课             | 当前课程       | 📚 book.fill |
| 距离下节课 ≤ 15分钟  | 下一节课+倒计时 | 🔔 bell.fill |
| 距离下节课 > 15分钟  | 下一节课       | 🕐 clock.fill |
| 今日无课             | 明日课程预告    | ✨ sparkles |

**今日无课状态：**
```
┌────────────────────────────┐
│ ✨ 今日无课                 │
│ 明天 1 门课 · 09:50 开始    │
└────────────────────────────┘
```

**即将上课提醒：**
```
┌────────────────────────────┐
│ 🔔 15分钟后 · 计算机网络    │
│ 📍仙II-220·👤张三·14:00    │
└────────────────────────────┘
```

---

### 内联锁屏 Widget（accessoryInline）

**尺寸：** 单行文本（显示在日期下方）

**显示内容：** 最简信息（一行文本）

**布局示例：**
```
📚 生物信息学 · 教一-207 · 15分钟后
```

**变体：**
```
📚 生物学 · 教一-207 · 09:50
🔔 下节课 · 数据结构 · 仙II-220 · 14:00
✨ 今日无课
```

**显示优先级：**
1. 课程名（可适度简化）
2. 教室（完整）
3. 时间/倒计时

---

### 圆形锁屏 Widget（accessoryCircular）

**尺寸：** 约 42x42 pt 圆形区域

**显示内容：**
- 课程图标 + 进度环
- 或今日课程数量

**方案1：进度环**
```
   ╭──────╮
  │  📚   │  ← 中心图标
  │ ▓▓▓░░ │  ← 外环显示今日课程进度
   ╰──────╯
```

**方案2：课程计数**
```
   ╭──────╮
  │   4   │  ← 今日剩余课程数
  │  节课  │
   ╰──────╯
```

**方案3：无课状态**
```
   ╭──────╮
  │   ✓   │  ← 对勾图标
  │  无课  │
   ╰──────╯
```

---

## 数据逻辑与时间规则

### 智能显示切换

**判断逻辑（按优先级）：**

```
1. 检查是否正在上课
   ├─ 是 → 显示"当前课程"（带剩余时间）
   └─ 否 → 继续

2. 检查是否有下节课
   ├─ 否 → 显示"今日无课"或"明日课程"
   └─ 是 → 继续

3. 计算距离下节课的时间
   ├─ ≤ 提前时间（15分钟）→ 高亮显示 + 倒计时
   ├─ > 15分钟 → 普通显示下节课
   └─ 今日课程已结束 → 显示明日课程
```

### 时间模板

**支持多学校作息时间：**

| 学校       | 每节课时长 | 上午节次  | 下午节次   |
|-----------|-----------|----------|-----------|
| 南京大学   | 50分钟     | 1-5节    | 6-11节    |
| 东南大学   | 45分钟     | 1-5节    | 6-11节    |

**时间段示例（南京大学）：**

| 节次 | 开始时间 | 结束时间 |
|------|---------|---------|
| 1    | 08:00   | 08:50   |
| 2    | 09:00   | 09:50   |
| 3    | 10:10   | 11:00   |
| 4    | 11:10   | 12:00   |
| 5    | 12:10   | 13:00   |
| ...  | ...     | ...     |

### 刷新策略

**Widget 刷新时机：**
1. **智能刷新：** 在下一节课开始时间自动刷新
2. **定时刷新：** 默认每15分钟刷新一次
3. **手动刷新：** 应用内更新数据后触发刷新
4. **事件触发：** 课程增删改后立即刷新

**Live Activity 更新：**
1. 创建后每5分钟更新一次倒计时
2. 课程开始时更新状态为"正在上课"
3. 临近结束时更新状态为"即将结束"

---

## 信息优先级

### 文本截断规则

#### **绝对不能截断（...）的信息：**
❌ **教室名称** - 这是用户行动的关键信息
❌ **上课时间** - 时间信息必须完整（如 `09:50`）
❌ **倒计时** - 剩余时间必须完整显示

#### **允许换行，超出才截断（...）：**
✅ **课程名称** - 最多2-3行，超出显示 `...`
✅ **状态文本** - 如"即将开始"可独立一行

#### **可以截断或省略的信息：**
✅ **授课教师** - 空间不足时可截断或省略
✅ **备注信息** - 次要信息，可省略

### SwiftUI 实现要点

**绝对不截断（教室、时间）：**
```swift
Text(classroom)
    .lineLimit(1)
    .fixedSize()  // 强制完整显示
    .truncationMode(.none)
```

**允许换行（课程名）：**
```swift
Text(courseName)
    .lineLimit(2)  // 最多2行
    .truncationMode(.tail)  // 超出显示...
```

**可以截断（教师）：**
```swift
Text(teacher)
    .lineLimit(1)
    .truncationMode(.tail)  // 允许...
```

---

## 交互与 Deep Linking

### URL Scheme

**Widget 点击跳转：**
- 主屏 Widget → `njuschedule://course/{courseId}`
- 锁屏 Widget → `njuschedule://today`
- Live Activity → `njuschedule://course/{courseId}`

**跳转目标：**
- 课程详情页（显示课程完整信息）
- 课程表页面（自动滚动到对应时间）

### 按钮交互

**Live Activity 按钮：**
1. "我已到达" → 关闭 Live Activity
2. "查看课表" → 打开 App 跳转到课程表

---

## 实现清单

### Phase 1：基础 Widget（MVP）

- [ ] 小组件（systemSmall）- 下一节课展示
- [ ] 中组件（systemMedium）- 今日课程列表（时间轴）
- [ ] 大组件（systemLarge）- 今日完整课表
- [ ] 锁屏矩形 Widget（accessoryRectangular）
- [ ] 锁屏内联 Widget（accessoryInline）
- [ ] 锁屏圆形 Widget（accessoryCircular）
- [ ] Flutter 数据服务连接（从 SQLite 读取课程数据）
- [ ] 应用启动/课程更新时刷新 Widget

### Phase 2：Live Activities

- [ ] 灵动岛基础实现（Compact + Expanded）
- [ ] 锁屏横幅视图
- [ ] 课前提醒创建逻辑（提前15分钟）
- [ ] 状态自动更新（upcoming → inProgress → ending）
- [ ] "我已到达"按钮功能
- [ ] 设置页面：实时活动开关 + 提前时间设置

### Phase 3：增强功能

- [ ] 智能时间切换（当前课程/下一节课）
- [ ] 小组件主题/颜色自定义
- [ ] Widget 配置选项（选择显示内容）
- [ ] 位置感知（自动关闭实时活动）
- [ ] 整周课表视图（可选）
- [ ] Widget 预览（在设置中预览效果）

### Phase 4：优化与测试

- [ ] 多学校时间模板测试
- [ ] 长课程名/长教室名边界测试
- [ ] 性能优化（Timeline 刷新策略）
- [ ] 无障碍支持（VoiceOver）
- [ ] 深色模式适配
- [ ] 本地化（中英文）

---

## 参考资料

**Apple 官方文档：**
- [WidgetKit Documentation](https://developer.apple.com/documentation/widgetkit)
- [ActivityKit Documentation](https://developer.apple.com/documentation/activitykit)
- [Live Activities Design Guidelines](https://developer.apple.com/design/human-interface-guidelines/live-activities)

**参考应用：**
- 课程格子 - 中组件时间轴设计
- 超级课程表 - 小组件信息密度
- WakeUp课程表 - Live Activities 交互
- iOS 原生日历 - 时间段可视化

---

## 版本历史

- **v1.0** (2024-10-15) - 初始设计规范
  - 定义 Widget 各尺寸内容
  - 定义 Live Activities 布局
  - 定义锁屏 Widget 设计
  - 明确信息优先级与截断规则

---

**文档维护者：** 开发团队
**最后更新：** 2024-10-15
